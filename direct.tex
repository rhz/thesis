In this chapter we show how to construct a set of reversible rules
and their forward and backward rate constants from an energy function.
In the spirit of rule-based modelling languages like Kappa
where rules and observables are defined in terms of patterns,\footnote{
  Recall that a pattern is a contact map used to find subgraphs in states.}
we use a set of \emph{energy patterns} $\shapes$
for our energy function.
We assign an \emph{energy cost} $\cost(g)$ to each of them
and build the energy function as a linear combination
of their number of ocurrences. % of each energy pattern.
\[ E(m) = \sum_{g \in \shapes} \cost(g) \abs{\matches{g}{m}} \]
This is reminiscent of group contribution methods
used to estimate the standard Gibbs free energy of formation
of biomolecules \citep{group-contrib}.

As mentioned at the end of \sct{kappa},
we will derive the set of rules with detailed balance
from a set of generator rules $\generators$ (without rates).
We suppose that $\generators$ is closed under
rule inversion, \ie $\generators = \inv{\generators}$.
Given a contact graph $C$,
a simple option would be to include
every possible minimal rule in this set,
that is, include a creation and a destruction rule
for each edge in the contact graph.
Each of these rules is minimal in the sense that
it only asks for the presence of
the two participating agents and sites.
The example rule in \sct{kappa} (page~\pageref{p:example})
where agents of type $1$ and $2$ bind
% regardless of the binding state of any other site,
regardless of the context
in which these two agents happen to be,
which we denote by $r^+_{12}$,
is one such minimal rule
that can be derived from contact graph $T$.
This option is \emph{maximally permissive}
% as every possible transformation
% allowed by the contact graph
% is allowed by $\generators$.\footnote{
with respect to the contact graph.\footnote{
  Intuitively, this is analogous to the case of classical mechanics
  % where the topology of the space gives us the possible transformations
  where, a priori, movement is not constrained along any coordinate.}
Even if all transformations are possible,
many of them may be unlikely due to having a high energy.
Still one might prefer to forbid certain transformations
in some scenarios.
This is indeed the case in the example
that will be presented in \sct{alloring}.

In our previous example (\sct{kappa}),
we might want to favour the formation of
triangles over chains and other cycles.
For this we give a negative energy cost to the trinagle $t$,
\ie $\cost(t) < 0$.
If $t$ is the only energy pattern,
then the energy of a state $m$ is
$E(m) = \cost(t) \abs{\matches{t}{m}}$.
In this model one might, for instance,
wonder how low the energy cost of $t$ must be
to have at least $90\%$ of all agents in a triangle
at equilibrium at least $90\%$ of the time.

We would like to find rules that have detailed balance
with respect to this energy function.
Consider the rule $r^+_{12}$ and its inverse $r^-_{12}$,
the unbinding of agents $1$ and $2$.
% Given the maximally permissive set of generator rules
% $\generators=\set{r^+_{12},r^-_{12},r^+_{23},r^-_{23},r^+_{31},r^-_{31}}$,
% we first ask ourselves if these reversible rules
We first ask ourselves if this pair of rules
could have detailed balance
for some assignment of kinetic rates.
% to the forward and backward rule.
Suppose we assign kinetic rates $k^+$ and $k^-$
to $r^+_{12}$ and $r^-_{12}$.
Recall from \sct{bg} that $e^{E(n)-E(m)} = q_{nm}/q_{mn}$
for systems with detailed balance.
From \eqn{kappa-ctmc}
\[ q_{mn} = \sum_{\substack{r \in \generators\\r = \tuple{r_L,r_R}}}
   k(r) \; \abs{\setof{\psi \in \matches{r_L}{m}}{m^{(r,\psi)} = n}}
\]
It is clear that at most one of the two rules
can bring us from state $m$ to $n$, say it is $r^+_{12}$.
By rule reversibility (\lem{reversibility})
$r^-_{12}$ brings us from $n$ back to $m$
and the number of matches of $r^-_{12}$ in $n$
is equal to the number of matches of $r^+_{12}$ in $m$.
Hence, $e^{E(n)-E(m)} = k^+/k^-$.
In words, the change in energy produced by the rule application
fixes the ratio between the kinetic rates.
As a consequence,
each rule application should produce the same energy change
for there to be an assignment of kinetic rates with detailed balance.
Whenever a rule produces the same energy change
regardless of where it is applied
we say that the rule has an \emph{unambiguous energy balance}
or is $\shapes$-balanced.
More generally, we define $\shapes$-balance as follows.

\begin{definition}
  Given a contact graph $C$
  and a set $\shapes$ of contact maps over $C$,
  a rule $r$ is $\shapes$-balanced
  if, for all mixtures $m$ and embeddings $\psi: r_L \to m$,
  the number of ocurrences of $p \in \shapes$
  produced and consumed by $r$ when applied to $\psi$
  is a fixed number
  $\Delta_r p = |[p;m^{(r,\psi)}]| - \abs{\matches{p}{m}}$.
  % is a fixed number $\Delta_r p$,
  % \ie $|[p;m^{(r,\psi)}]| - \abs{\matches{p}{m}} = \Delta_r p\;$
  % for all $p \in \shapes$.
  We refer to $\Delta_r p$ as the balance of $r$ with respect to $p$.
  % We refer to the vector of ocurrence changes as $\Delta_r \shapes$.
\end{definition}
% TODO: perhaps add a remark about unambiguous stoichiometry

The following two rule applications show that
$r^+_{12}$ is not $\shapes$-balanced.
\begin{center}
  \resizebox{.9\linewidth}{!}{%
  \begin{tikzpicture}[thick]
    % first row
    \node[grphnode,anchor=east] (lhs1) at (0,0) {
      \tikz[ingrphdiag]{
        \begin{scope}[shift={(0,0)}]
          \n[n1]{x}{0,0};
          \e{x}{.5,0};
          \site{rx}{x.east};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(1.2,0)}]
          \n[n2]{y}{0,0};
          \e{y}{-.5,0};
          \site{ly}{y.west};
          \node at (206:.42) {\scriptsize $l$};
        \end{scope}
      }};
    \path (lhs1.east) +(.3,0) edge[rule,dotted] +(1,0)
      +(1.3,0) coordinate (r1);
    \node[grphnode,anchor=west] (rhs1) at (r1) {
      \tikz[ingrphdiag]{
        \e{0,0}{1.1,0};
        \begin{scope}
          \n[n1]{x}{0,0};
          \site{rx}{x.east};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(1.1,0)}]
          \n[n2]{y}{0,0};
          \site{ly}{y.west};
          \node at (206:.42) {\scriptsize $l$};
        \end{scope}
      }};
    % second column
    \node[grphnode,anchor=east] (lhs2) at (9,0) {
      \tikz[ingrphdiag]{
        \begin{scope}[shift={(0,0)}]
          \n[n1]{x}{0,0};
          \e{x}{.5,0};
          \site{rx}{x.east};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(1.2,0)}]
          \n[n2]{y}{0,0};
          \e{y}{-.5,0};
          \site{ly}{y.west};
          \node at (206:.42) {\scriptsize $l$};
        \end{scope}
      }};
    \path (lhs2.east) +(.3,0) edge[rule,dotted] +(1,0)
      +(1.3,0) coordinate (r2);
    \node[grphnode,anchor=west] (rhs2) at (r2) {
      \tikz[ingrphdiag]{
        \e{0,0}{1.1,0};
        \begin{scope}
          \n[n1]{x}{0,0};
          \site{rx}{x.east};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(1.1,0)}]
          \n[n2]{y}{0,0};
          \site{ly}{y.west};
          \node at (206:.42) {\scriptsize $l$};
        \end{scope}
      }};
    % second row
    \path (lhs1.south) +(0,-.2) edge[rule] +(0,-.6);
    \node[grphnode,anchor=east] (lhs3) at (0,-2) {
      \tikz[ingrphdiag]{
        \begin{scope}[shift={(0,0)}]
          \n[n1]{x}{0,0};
          \e{x}{.5,0};
          \e{x}{-.5,0};
          \site{lx}{x.west};
          \site{rx}{x.east};
          \node at (206:.42) {\scriptsize $l$};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \e{1.2,0}{2.3,0};
        \begin{scope}[shift={(1.2,0)}]
          \n[n2]{y}{0,0};
          \e{y}{-.5,0};
          \site{ly}{y.west};
          \site{ry}{y.east};
          \node at (206:.42) {\scriptsize $l$};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(2.3,0)}]
          \n[n3]{z}{0,0};
          \e{z}{.5,0};
          \site{lz}{z.west};
          \site{rz}{z.east};
          \node at (206:.42) {\scriptsize $l$};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
      }};
    \path (lhs3.east) +(.3,0) edge[rule,dotted] +(1,0)
      +(1.3,0) coordinate (r3);
    \path (rhs1.south) +(0,-.2) edge[rule] +(0,-.6);
    \node[grphnode,anchor=west] (rhs3) at (r3) {
      \tikz[ingrphdiag]{
        \e{0,0}{2.2,0};
        \begin{scope}[shift={(0,0)}]
          \n[n1]{x}{0,0};
          \e{x}{-.5,0};
          \site{lx}{x.west};
          \site{rx}{x.east};
          \node at (206:.42) {\scriptsize $l$};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(1.1,0)}]
          \n[n2]{y}{0,0};
          \site{ly}{y.west};
          \site{ry}{y.east};
          \node at (206:.42) {\scriptsize $l$};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(2.2,0)}]
          \n[n3]{z}{0,0};
          \e{z}{.5,0};
          \site{lz}{z.west};
          \site{rz}{z.east};
          \node at (206:.42) {\scriptsize $l$};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
      }};
    % second row, second column
    \path (lhs2.south) +(0,-.2) edge[rule] +(0,-.6);
    \node[grphnode,anchor=east] (lhs4) at (9,-2.4) {
      \tikz[ingrphdiag]{
        \e{0,0}{-56.944:1.1};
        \e{0:1.2}{-56.944:1.1};
        \begin{scope}[shift={(0,0)}]
          \n[n1]{x}{0,0};
          \e{x}{.5,0};
          \site{r1}{0:7pt};
          \site{l1}{-60:7pt};
          \node at (-86:12pt) {\scriptsize $l$};
          \node at (26:12pt) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(0:1.2)}]
          \n[n2]{y}{0,0};
          \e{y}{-.5,0};
          \site{r2}{180:7pt};
          \site{l2}{-120:7pt};
          \node at (154:12pt) {\scriptsize $l$};
          \node at (-94:12pt) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(-56.944:1.1)}]
          \n[n3]{z}{0,0};
          % angle is 66.111 deg
          \site{r3}{123.0555:7pt};
          \site{l3}{56.9445:7pt};
          \node at (146:12pt) {\scriptsize $r$};
          \node at (34:12pt) {\scriptsize $l$};
        \end{scope}
      }};
    \path (lhs4.east) +(.3,0) edge[rule,dotted] +(1,0)
      +(1.3,0) coordinate (r4);
    \path (rhs2.south) +(0,-.2) edge[rule] +(0,-.6);
    \node[grphnode,anchor=west] (rhs4) at (r4) {
      \tikz[ingrphdiag]{
        \e{0,0}{0:1.1};
        \e{0,0}{-60:1.1};
        \e{0:1.1}{-60:1.1};
        \begin{scope}[shift={(0,0)}]
          \n[n1]{x}{0,0};
          \site{r1}{0:7pt};
          \site{l1}{-60:7pt};
          \node at (-86:12pt) {\scriptsize $l$};
          \node at (26:12pt) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(0:1.1)}]
          \n[n2]{y}{0,0};
          \site{r2}{180:7pt};
          \site{l2}{-120:7pt};
          \node at (154:12pt) {\scriptsize $l$};
          \node at (-94:12pt) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(-60:1.1)}]
          \n[n3]{z}{0,0};
          \site{r3}{120:7pt};
          \site{l3}{60:7pt};
          \node at (146:12pt) {\scriptsize $r$};
          \node at (34:12pt) {\scriptsize $l$};
        \end{scope}
      }};
  \end{tikzpicture}}
\end{center}

We see that, while the application on the left
does not produce any change in energy ($\Delta E = 0$),
the one on the right creates a triangle
and thus $\Delta E = \cost(t)$. %\footnote{
%   And we won't tolerate energetical ambiguity in this house!}
We must then split $r^+_{12}$ into subrules that check
the surroundings of the rule application
to make sure that, for instance,
every application of such a subrule
creates one triangle or none at all.
It is important that the partition of the rule
has certain properties.
In particular, one would like that every match of the rule
can be mapped to exactly one match of one of the subrules.
Prior work by \citet{refinement} has shown how
one can obtain a partition of rules with this property
and will be presented, in a slightly modified version,
in \sct{refinements}. % the next section.
% NOTE: not possible to put refinement section
% before minimal glueings because the proof of the
% unique decomposition theorem uses minimal glueings.

But before diving into rule partitioning,
or rule refinement as we call it,
it would be good to have a more rigourous idea of
when a rule is $\shapes$-balanced or not.
In the examples shown above we see that
our energy pattern, the triangle,
must be fully incorporated into
the left- or the right-hand side of the rule
to be sure it produces or consumes it in every application.
On the other hand, a rule that is incompatible
with our energy pattern will also be $\shapes$-balanced
by making it impossible for the rule to match a triangle.
This is true whenever there is no glueing % union
of the left-hand side of a rule with the energy pattern
where they overlap in a site that is modified by the rule.
In the next section,
we introduce the concept of overlapping glueings
of contact maps by means of multi-sums,
a concept related to local coproducts and relative pushouts.
% in $\rSGe_C$.


\section{Minimal glueings}
\label{sec:mg}

The category $\SG$ has all pullbacks,
constructed from those in $\Set$,
and they indeed restrict to $\rSGe_C$.

\begin{lemma}\label{lemma:pullbacks}
  Given a cospan $\phi_1: g_1 \to h \gets g_2 :\phi_2$ in $\rSGe_C$
  there is a unique span $\psi_1: g_1 \gets p \to g_2 :\psi_2$
  (up to unique isomorphism)
  such that any span $\omega_1: g_1 \gets q \to g_2 :\omega_2$
  that forms a commuting square $\omega_1,\omega_2,\phi_1,\phi_2\;$
  factors \emph{uniquely} through it.
  \begin{center}
    \begin{tikzpicture}
      \node (h1) at (0,0) {$g_1$};
      \node (h2) at (6,0) {$g_2$};
      \node (h) at (3,-1) {$h$};
      \node (p) at (3,1) {$p$};
      \node (q) at (3,2.2) {$q$};
      \draw (q) edge[hom,bend right=20] node[above left] {$\omega_1$} (h1);
      \draw (q) edge[hom,bend left=20] node[above right] {$\omega_2$} (h2);
      \draw[hom] (p) -- node[above] {$\psi_1$} (h1);
      \draw[hom] (p) -- node[above] {$\psi_2$} (h2);
      \draw[hom] (h1) -- node[below] {$\phi_1$} (h);
      \draw[hom] (h2) -- node[below] {$\phi_2$} (h);
      \draw[hom,dotted] (q) -- node[right] {$!$} (p);
    \end{tikzpicture}
  \end{center}
\end{lemma}
\begin{proof}
  We construct contact map $p: G \to C$ by taking the intersection
  of the agents, sites and edges in the image of $\phi_1,\phi_2$
  and restricting $\sitemap$ accordingly.
  With some abuse of notation, we have
  \begin{alignat*}{3}
    \agents_G & {}= \phi_{1,\agents}(\agents_{\anon{g_1}}) & {}\cap{} &
                  \,\phi_{2,\agents}(\agents_{\anon{g_2}}) \\
    \sites_G & {}= \,\phi_{1,\sites}(\sites_{\anon{g_1}}) & {}\cap{} &
                 \,\,\phi_{2,\sites}(\sites_{\anon{g_2}}) \\
    \edges_G & {}= \,\phi_{1,\sites}(\edges_{\anon{g_1}}) & {}\cap{} &
                 \,\,\phi_{2,\sites}(\edges_{\anon{g_2}})
  \end{alignat*}
  and $\sitemap_G = \rest{\sitemap_{\anon{h}}}{\sites_G}$.
  Functions $p_\agents,p_\sites$ are the restriction of
  $h_\agents,h_\sites$ to $\agents_G,\sites_G$, respectively.
  Embeddings $\psi_1$ and $\psi_2$ map agents and sites
  in $G$ to their pre-images along $\phi_1$ and $\phi_2$;
  by construction, all agents and sites in $G$
  are guaranteed to have such a pre-image.
  It is easy to see that
  (i) $\psi_1$ and $\psi_2$ are type-preserving
  and thus embeddings in $\rSGe_C$; and that
  (ii) the square formed by $\psi_1,\psi_2,\phi_1,\phi_2$ commutes.

  Consider any span $\omega_1: g_1 \gets q \to g_2 :\omega_2$ in $\rSGe_C$.
  If the square formed by $\omega_1$, $\omega_2,\phi_1,\phi_2$ commutes,
  then $q$ can have at most one copy of each agent and site
  in the intersection of the images of $\phi_1$ and $\phi_2$
  because $\phi_1\,\omega_1$ and $\phi_2\,\omega_2$ are injective.
  Hence, every agent and site in the image of $\omega_1,\omega_2$
  has a \emph{unique} pre-image along $\psi_1,\psi_2$, respectively,
  with the same type.
  This fixes a pair of functions $\omega_\agents,\omega_\sites$
  that map agents and sites in $q$ to those in $p$ injectively
  and form an embedding $\omega$ in $\rSGe_C$.
  Since the pre-image along $\psi_1,\psi_2$ always exists and is unique,
  any embedding $\omega': p \to q$ must be equal to $\omega$
  whenever $\phi_1\,\omega' = \omega_1$ and
  $\phi_2\,\omega' = \omega_2$.
\end{proof}

$\SG$ also has all pushouts and all sums,
but these do not in general restrict to $\rSGe_C$,
just as pushouts and sums in $\Set$ do not restrict to
the subcategory of injective functions.
% all pushouts; but these do not generally restrict to $\rSGe_C$ since
% (i) the pushout object need not be realisable,
% even if all objects in the starting span were;
% (ii) the arrows in the resulting cospan need not be embeddings,
% even if all arrows in the starting span were;
% and (iii) the mediating arrow need not even be injective
% (on agents or sites).
However, $\rSGe_C$ has \emph{multi-sums}.

\begin{lemma}\label{lemma:mg}
  For all pairs of contact maps over $C$,
  $g_1: G_1 \to C$ and $g_2: G_2 \to C$,
  % there exists a finite set $I$ and a family of cospans ... with i \in I
  there exists a finite family of cospans
  $\theta^i_1: g_1 \to s_i \gets g_2 :\theta^i_2$,
  such that any cospan $\phi_1: g_1 \to h \gets g_2 :\phi_2\;$
  factors through \emph{exactly one} of the family
  and does so \emph{uniquely}.
  \begin{center}
    \begin{tikzpicture}
      \node (h1) at (0,0) {$g_1$};
      \node (si) at (1.8,0) {$s_i$};
      \node (h2) at (3.6,0) {$g_2$};
      \node (h) at (1.8,-1.8) {$h$};
      \draw[hom] (h1) -- node[above] {$\theta^i_1$} (si);
      \draw[hom] (h2) -- node[above] {$\theta^i_2$} (si);
      \draw[hom] (h1) -- node[below left] {$\phi_1$} (h);
      \draw[hom] (h2) -- node[below right] {$\phi_2$} (h);
      \draw[hom,dotted] (si) -- node[right] {$!$} (h);
    \end{tikzpicture}
  \end{center}
\end{lemma}
\begin{proof}
  Take subsets $A_i$ of the cartesian product
  of $\agents_{\anon{g_1}}$ and $\agents_{\anon{g_2}}$
  that have each agent of $g_1$ and $g_2$ at most once
  ($(a,b) \in A_i \wedge (a,b') \in A_i \then b = b'$)
  and where each pair $(a,b) \in A_i$ has the same type,
  % that are type-compatible,
  \ie $g_{1,\agents}(a) = g_{2,\agents}(b)$.
  % for all $(a,b) \in A_i$,
  To each $A_i$ assign all subsets $S_{ij}$ of
  $\sites_{\anon{g_1}} \times \sites_{\anon{g_2}}$
  that are type-compatible
  and whose elements belong to agents paired in $A_i$,
  that is, if $(x,y) \in S_{ij}$
  then $g_{1,\sites}(x) = g_{2,\sites}(y)$
  and $(\sitemap_{\anon{g_1}}(x),\sitemap_{\anon{g_2}}(y)) \in A_i$.
  % Note that the latter predicate fixes ...
  Note how this fixes a mapping $\sitemap_{ij}$
  between elements of $S_{ij}$ to elements of $A_i$
  defined by
  $\sitemap_{ij}((x,y)) =
     (\sitemap_{\anon{g_1}}(x),\sitemap_{\anon{g_2}}(y))$.
  % Discard all sets $S_ij$ that are subsets
  % of a set $S_jk$ with $j \neq k$.
  For each $A_i$ keep only the set $S_{ij}$
  that is a superset of all other sets $S_{ik}$ ($k \neq j$).
  % and discard all others.
  There must be one such maximal set because
  if any two pairs of sites $(x_1,y_1),(x_2,y_2)$
  are type-preserving and belong to the same agents,
  then there will be one set among the $S_{ij}$s that has both
  and thus $\{S_{ij}\}_j$ is a directed partial order
  for the inclusion relation.
  % Hence, we can drop the $j$ subscript
  % in $S_{ij}$ and $\sitemap_{ij}$.
  Let $S_i$ be the maximal element of $\{S_{ij}\}_j$,
  which exists by directedness and finiteness of this family,
  and $\sitemap_i$ the corresponding mapping to $A_i$.
  Intuitively, the maximal set $S_i$ is the set of all sites
  that are defined in both agents at the same time.
  Next we discard those pairs $A_i,S_i$
  whose elements do not agree on their edge structure;
  if $(x,y) \in S_i$ then either both sites must be free
  or connected to sites $(x',y') \in S_i$.

  We construct a family of contact maps $p_i: P_i \to C$
  using $\agents_{P_i} = A_i$ as its agents,
  $\sites_{P_i} = S_i$ as its sites,
  $\sitemap_{P_i} = \sitemap_i$ and
  $\edges_{P_i} = \{((x_1,y_1), (x_2,y_2)) \in S_i \times S_i \st
     x_1 \edges_{\anon{g_1}} x_2 \wedge
     y_1 \edges_{\anon{g_2}} y_2\}$.
  Functions $p_{i,\agents},p_{i,\sites}$
  are defined straightforwardly.
  Spans $\psi^i_1: g_1 \gets p_i \to g_2 :\psi^i_2$
  are then obtained by mapping agents $(a,b)$ in $p_i$
  to $a$ in $g_1$ and $b$ in $g_2$
  and similarly for sites.
  Multi-sums $\theta^i_1: g_1 \to s_i \gets g_2 :\theta^i_2$
  are pushouts of such spans:
  they are obtained by adding to $p_i$
  all the missing agents, sites and edges from $g_1$ and $g_2$.
  Since all sites that are in $g_1$ but not in $p_i$
  cannot be in $g_2$ by maximality of $S_i$,
  there can be no conflict when adding sites or edges.
  The same argument holds for sites in $g_2$ that are not in $p_i$.

  Note that the family $A_i$ is finite
  and thus the family of multi-sums is finite as well.
  Also, it is easy to see that the spans $\psi^i_1,\psi^i_2$
  are pullbacks of $\theta^i_1,\theta^i_2$.
  Hence, (isomorphism classes of) multi-sums
  are in a one-to-one correspondence
  with (isomorphism classes of) pullbacks.
  This implies that there is only one multi-sum
  that factors any given cospan.
\end{proof}

The pairs $\theta^i_1,\theta^i_2$ enumerate
all minimal ways in which one can glue $g_1$ and $g_2$.
% and thus all the minimal contexts in which they can occur.
Hence, we refer to them as minimal glueings.
%
The notion of multi-sum dates back to \citet{diers}.
% We call them \emph{minimal glueings} in $\rSGe_C$
% according to their intuition in this concrete context
% and use them in \sct{energy-gp} to construct balanced rules.
% TODO: elaborate on relation to RPOs
They are very close to relative pushouts \citep{leifer}
and will be used in the same way,
to minimise rewriting contexts.
Indeed, each minimal glueing $i$
in the family of cospans $\theta^i_1,\theta^i_2$
accounts for one minimal rewriting context.

To illustrate how this construction operates,
consider the minimal glueings of the following
two contact maps over $T$ % (the triangle)
with their respective pullbacks.
% as shown in the following diagram.
\input{mg}

I have implemented an online tool that computes minimal glueings
available at \url{https://rhz.github.com/thesis/mg.html}.
Its source code can be found at \url{https://github.com/rhz/thesis/}.

Using minimal glueings we can test whether
a rule $r$ is $\shapes$-balanced,
that is, whether $r$ consumes and produces
the same number of instances of each energy pattern $p$
when applied to any mixture $m$.
In particular, for an $r$-event $\psi$
to \emph{consume} an instance $\phi$ of $p$ in a mixture $m$,
$\phi_\sites$ and $\psi_\sites$ must have images
which intersect on at least one site which is modified by $r$
(\eg by adding an edge if it was free). % or removing its edge).
% Otherwise the energy pattern is left intact by the action of the rule.
This is the case iff
the minimal glueing $\phi',\psi'$ of $r_L$ and $p$
\begin{wrapfigure}[5]{r}{0.41\textwidth}
  \vspace{-1.8em}
  \begin{equation}
    \label{eq:p-balanced}
    \tikz[baseline=-1.1cm]{
  % \begin{center}
  %   \begin{tikzpicture}
      \node (p) at (0,0) {$p$};
      \node (s) at (1.8,0) {$s$};
      \node (l) at (3.6,0) {$r_L$};
      \node (m) at (1.8,-1.8) {$m$};
      \draw[hom] (p) -- node[above] {$\phi'$} (s);
      \draw[hom] (l) -- node[above] {$\psi'$} (s);
      \draw[hom] (p) -- node[below left] {$\phi$} (m);
      \draw[hom] (l) -- node[below right] {$\psi$} (m);
      \draw[hom,dotted] (s) -- (m);}
  %   \end{tikzpicture}
  % \end{center}
    \end{equation}
\end{wrapfigure}
that factors the cospan $\phi,\psi$ has the same property.
Likewise, for an $r$-event to \emph{produce} an instance of $p$,
the associated minimal glueing between $p$ and $r_R$
must have a modified intersection.
We call such minimal glueings \emph{relevant}.
% ; they are the ones which underlie events
% that can affect the instances of $p$.

To illustrate the idea of relevant minimal glueings,
let us consider a different example.
In this example, the contact graph is very simple:
just one agent type with two sites, $l$ and $r$,
that can bind each other.
% The maximally permissive set of generators rules
% contains only one reversible rule.
% One extension of this rule is
Imagine we have the following reversible rule.
\begin{center}
  \begin{tikzpicture}[thick]
    \node[grphnode,anchor=east] (lhs1) at (0,0) {
      \tikz[ingrphdiag]{
        \e{0,0}{2.2,0};
        \begin{scope}
          \n[n]{x}{0,0};
          \site{rx}{x.east};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(1.1,0)}]
          \n[n]{y}{0,0};
          \site{ly}{y.west};
          \site{ry}{y.east};
          \node at (206:.42) {\scriptsize $l$};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(2.2,0)}]
          \n[n]{z}{0,0};
          \site{lz}{z.west};
          \node at (206:.42) {\scriptsize $l$};
        \end{scope}
      }};
    \path (lhs1.east) +(.3,0) edge[rule] +(1,0)
      +(1.3,0) coordinate (r1);
    \node[grphnode,anchor=west] (rhs1) at (r1) {
      \tikz[ingrphdiag]{
        \e{1.1,0}{2.3,0};
        \begin{scope}[shift={(0,0)}]
          \n[n]{x}{0,0};
          \e{x}{.5,0};
          \site{rx}{x.east};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(1.2,0)}]
          \n[n]{y}{0,0};
          \e{y}{-.5,0};
          \site{ly}{y.west};
          \site{ry}{y.east};
          \node at (206:.42) {\scriptsize $l$};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(2.3,0)}]
          \n[n]{z}{0,0};
          \site{lz}{z.west};
          \node at (206:.42) {\scriptsize $l$};
        \end{scope}
      }};
  \end{tikzpicture}
\end{center}
Take the chain of 3 agents as our energy pattern.
The minimal glueings of the left-hand side of the rule
with the energy pattern are shown below.
On the left of each diagram is the energy pattern.
The relevant minimal glueings are marked
with a light green background.
\input{relevant-mg}

Whenever $\psi': r_L \to s$ in \diagram{p-balanced} is an iso,
then the energy pattern $p$ is fully included % contained
in the left-hand side of rule $r$.
This implies the rule contains all the relevant context needed
to make sure that an instance of $p$ is consumed
by any $r$-event $\psi: r_L \to m$.
We say that $r$ is $\shapes$-\emph{left-balanced} iff,
for all $p \in \shapes$ and relevant minimal glueings
$\theta^i_1: p \to s_i \gets r_L :\theta^i_2$,
the right leg $\theta^i_2$ is an isomorphism.
Symmetrically, one says that $r$ is $\shapes$-\emph{right-balanced}
iff $\inv{r}$ is $\shapes$-left-balanced.
Then $r$ is $\shapes$-\emph{balanced}
iff it is $\shapes$-left- and $\shapes$-right-balanced.

\begin{lemma}
  Rule $r$ is $\shapes$-balanced if and only if
  $r$ is $\shapes$-left- and $\shapes$-right-balanced.
  Moreover, for any mixture $m$ and embedding $\psi: r_L \to m$,
  \[ \Delta_r p = |[p;m^{(r,\psi)}]| % \abs{\matches{p}{\comatch{m}}}
                - \abs{\matches{p}{m}}
                = \abs{\matches{p}{r_R}}
                - \abs{\matches{p}{r_L}} \]
\end{lemma}
\begin{proof}
  Suppose there are two mixtures $m$, $n$
  and embeddings $\psi: r_L \to m$, $\phi: r_L \to n$
  such that, when $r$ is applied to $\psi$ and $\phi$,
  it has a different balance
  with respect to a pattern $p \in \shapes$,
  \ie $|[p;m^{(r,\psi)}]| - \abs{\matches{p}{m}} \neq
  |[p;n^{(r,\phi)}]| - \abs{\matches{p}{n}}$.
  %
  We have
  \begin{equation*}
    \abs{\matches{p}{m}} = |\{p \to m \getsby{\psi} r_L\}|
    = \abs{\set{\tikz[baseline=-.6cm,x=1.2cm,y=1.2cm]{
      \node (p) at (0,0) {$p$};
      \node (s) at (1,0) {$s$};
      \node (l) at (2,0) {$r_L$};
      \node (m) at (1,-1) {$m$};
      \draw[hom] (p) -- (s);
      \draw[hom] (p) -- (m);
      \draw[hom] (l) -- (s);
      \draw[hom] (l) -- node[below right] {$\psi$} (m);
      \draw[hom,dotted] (s) -- (m);}}}
  \end{equation*}
  where $p \to s \gets r_L$ is the minimal glueing
  that factors the cospan $p \to m \getsby{\psi} r_L$.
  A similar equality can be obtained for $r_R$,
  $m^{(r,\psi)}$ and $\comatch{\psi}$.
  %
  The \emph{irrelevant} minimal glueings on each side of the rule
  are in bijection: the rule does not destroy nor create them.
  Hence, when taking the difference
  $|[p;m^{(r,\psi)}]| - \abs{\matches{p}{m}}$
  they cancel each other out and we are left with
  a difference of \emph{relevant} minimal glueings on each side.
  %
  Since $s \iso r_L$ for each relevant minimal glueing on the left
  then
  \begin{equation*}
    \abs{\set{\tikz[baseline=-.6cm,x=1.2cm,y=1.2cm]{
      \node (p) at (0,0) {$p$};
      \node (s) at (1,0) {$s$};
      \node (l) at (2,0) {$r_L$};
      \node (m) at (1,-1) {$m$};
      \draw[hom] (p) -- (s);
      \draw[hom] (p) -- (m);
      \path (l) -- node[onarrow] {$\iso$} (s);
      \draw[hom] (l) -- node[below right] {$\psi$} (m);
      \draw[hom,dotted] (s) -- (m);}}}
    = \abs{\matches{p}{r_L}}
  \end{equation*}
  Again, a similar equality can be obtained for $r_R$,
  $m^{(r,\psi)}$ and $\comatch{\psi}$.
  Thus we have proved that
  $|[p;m^{(r,\psi)}]| - \abs{\matches{p}{m}} =
  \abs{\matches{p}{r_R}} - \abs{\matches{p}{r_L}}$
  for any $m$ and $\psi$,
  contradicting our original assumption.
\end{proof}


\section{Refinements}
\label{sec:refinements}

A rule is refined into another rule by adding context.
For example, we can add a common neighbour
to the agents in $r^+_{12}$ to obtain a refinement.
% \begin{center}
%   \begin{tikzpicture}
\begin{equation}
  \label{eq:refined1}
  \tikz[baseline=-.16cm]{
    \node[grphnode,anchor=east] (lhs) at (0,0) {
      \tikz[ingrphdiag]{
        \e{0,0}{-56.944:1.1};
        \e{0:1.2}{-56.944:1.1};
        \begin{scope}[shift={(0,0)}]
          \n[n1]{x}{0,0};
          \e{x}{.5,0};
          \site{r1}{0:7pt};
          \site{l1}{-60:7pt};
          \node at (-86:12pt) {\scriptsize $l$};
          \node at (26:12pt) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(0:1.2)}]
          \n[n2]{y}{0,0};
          \e{y}{-.5,0};
          \site{r2}{180:7pt};
          \site{l2}{-120:7pt};
          \node at (154:12pt) {\scriptsize $l$};
          \node at (-94:12pt) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(-56.944:1.1)}]
          \n[n3]{z}{0,0};
          % angle is 66.111 deg
          \site{r3}{123.0555:7pt};
          \site{l3}{56.9445:7pt};
          \node at (146:12pt) {\scriptsize $r$};
          \node at (34:12pt) {\scriptsize $l$};
        \end{scope}
      }};
    \path (lhs.east) +(.3,0) edge[rule] +(1,0)
      +(1.3,0) coordinate (r);
    \node[grphnode,anchor=west] (rhs) at (r) {
      \tikz[ingrphdiag]{
        \e{0,0}{0:1.1};
        \e{0,0}{-60:1.1};
        \e{0:1.1}{-60:1.1};
        \begin{scope}[shift={(0,0)}]
          \n[n1]{x}{0,0};
          \site{r1}{0:7pt};
          \site{l1}{-60:7pt};
          \node at (-86:12pt) {\scriptsize $l$};
          \node at (26:12pt) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(0:1.1)}]
          \n[n2]{y}{0,0};
          \site{r2}{180:7pt};
          \site{l2}{-120:7pt};
          \node at (154:12pt) {\scriptsize $l$};
          \node at (-94:12pt) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(-60:1.1)}]
          \n[n3]{z}{0,0};
          \site{r3}{120:7pt};
          \site{l3}{60:7pt};
          \node at (146:12pt) {\scriptsize $r$};
          \node at (34:12pt) {\scriptsize $l$};
        \end{scope}
      }};
  }
\end{equation}
%   \end{tikzpicture}
% \end{center}
This refinement happens to be $\shapes$-balanced.
Another refinement of $r^+_{12}$ could be
% \begin{center}
%   \begin{tikzpicture}
\begin{equation}
  \label{eq:refined2}
  \tikz[baseline=-.16cm]{
    \node[grphnode,anchor=east] (lhs) at (0,0) {
      \tikz[ingrphdiag]{
        \begin{scope}[shift={(0,0)}]
          \n[n1]{x}{0,0};
          \e{x}{.5,0};
          \site{rx}{x.east};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(1.2,0)}]
          \n[n2]{y}{0,0};
          \e{y}{-.5,0};
          \e{y}{.5,0};
          \site{ly}{y.west};
          \site{ry}{y.east};
          \node at (206:.42) {\scriptsize $l$};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
      }};
    \path (lhs.east) +(.3,0) edge[rule] +(1,0)
      +(1.3,0) coordinate (r);
    \node[grphnode,anchor=west] (rhs) at (r) {
      \tikz[ingrphdiag]{
        \e{0,0}{1.1,0};
        \begin{scope}
          \n[n1]{x}{0,0};
          \site{rx}{x.east};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(1.1,0)}]
          \n[n2]{y}{0,0};
          \e{y}{-.5,0};
          \e{y}{.5,0};
          \site{ly}{y.west};
          \site{ry}{y.east};
          \node at (206:.42) {\scriptsize $l$};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
      }};
  }
\end{equation}
%   \end{tikzpicture}
% \end{center}
Here we have added a free site to the blue node.
This second refinement is also $\shapes$-balanced
because the free $r$ site on the blue node guarantees that
(i) the rule will never create a triangle and
(ii) there is no embedding from the left-hand side
into a triangle and hence no triangle can be destroyed
by the action of the rule.
The following refinement, however, is not $\shapes$-balanced.
\begin{center}
  \begin{tikzpicture}
    \node[grphnode,anchor=east] (lhs) at (0,0) {
      \tikz[ingrphdiag]{
        \begin{scope}[shift={(0,0)}]
          \n[n1]{x}{0,0};
          \e{x}{.5,0};
          \site{rx}{x.east};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \e{1.2,0}{2.3,0};
        \begin{scope}[shift={(1.2,0)}]
          \n[n2]{y}{0,0};
          \e{y}{-.5,0};
          \site{ly}{y.west};
          \site{ry}{y.east};
          \node at (206:.42) {\scriptsize $l$};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(2.3,0)}]
          \n[n3]{z}{0,0};
          \site{lz}{z.west};
          \node at (206:.42) {\scriptsize $l$};
        \end{scope}
      }};
    \path (lhs.east) +(.3,0) edge[rule] +(1,0)
      +(1.3,0) coordinate (r);
    \node[grphnode,anchor=west] (rhs) at (r) {
      \tikz[ingrphdiag]{
        \e{0,0}{2.2,0};
        \begin{scope}[shift={(0,0)}]
          \n[n1]{x}{0,0};
          \site{rx}{x.east};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(1.1,0)}]
          \n[n2]{y}{0,0};
          \site{ly}{y.west};
          \site{ry}{y.east};
          \node at (206:.42) {\scriptsize $l$};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(2.2,0)}]
          \n[n3]{z}{0,0};
          \site{lz}{z.west};
          \node at (206:.42) {\scriptsize $l$};
        \end{scope}
      }};
  \end{tikzpicture}
\end{center}

We add context to a rule $r = \tuple{r_L,r_R}$
by applying the rule to an embedding $\psi: r_L \to g$.
This operation is well-defined
even if the codomain of the embedding is not a mixture.
% The result of the rewrite $g^{(r,\psi)}$
The pair of contact maps $(g,g^{(r,\psi)})$
% with $g^{(r,\psi)}$ the result of the rewrite
is itself a valid rule
since they only differ in their edge structure.
In this way, an extension of a rule
is determined uniquely by an embedding.

Epis\footnote{
  Epi, mono and iso are short for
  epimorphism, monomorphism and isomorphism.}
of $\rSGe_C$ are good candidates for extensions. % relevant
They are characterised as follows:
an embedding $\psi: g \to h$ is an epi iff
every connected component of $\anon{h}$ contains
at least one agent in the image of $\psi_\agents$.
This ensures that no new connected component is added to the rule
while extending it.
However, for technical reasons
that will become apparent in \thm{unique-decomposition},
we use prefixes of epis
instead of epis to extend rules ---
an embedding $\psi: g \to h$ is said to be
a \emph{prefix} of $\phi: g \to h'$
if there is some embedding $\theta: h \to h'$
that makes the composition of $\psi$ and $\theta$ equal to $\phi$
(\ie $\theta \, \psi = \phi$) % psychology + tetas = philosophy
and write $\psi \leq \phi$ for this.
We refer to a prefix
\begin{wrapfigure}[5]{r}{0.27\textwidth}
  \vspace{-2em}
  \begin{center}
    \begin{tikzpicture}
      \matrix (m) [matrix of math nodes,row sep=25pt,column sep=25pt] {
        & g & \\
        h & & h' \\};
      \draw[hom] (m-1-2) -- node[above left] {$\psi$} (m-2-1);
      \draw[hom] (m-1-2) -- node[above right] {$\phi$} (m-2-3);
      \draw[hom] (m-2-1) -- node[below] {$\theta$} (m-2-3);
    \end{tikzpicture}
  \end{center}
\end{wrapfigure}
of an epi $\psi: g \to h$ as an \emph{extension} of $g$.
In the category of extensions of $g$,
a morphism between objects $\psi: g \to h$ and $\phi: g \to h'$
is an embedding $\theta: h \to h'$
such that the triangle on the right commutes.
If $\theta$ is an iso we write $\psi \cong_g \phi$.

One might wonder when the prefix of an epi is not itself an epi.
The following diagram illustrates such a situation,
% where $\theta$ is the witness of $\psi \leq \phi$.
where $\psi$ is a prefix of epi $\phi$
but is not itself an epi since the connected component
of the blue node in the codomain of $\psi$
is not in the image of $\psi_\agents$.
\begin{center}
  \begin{tikzpicture}
    \node[grphnode,outer sep=.3cm] (g) at (0,0) {
      \tikz[ingrphdiag]{
        \n[n1]{x}{0,0};
      }};
    \node[grphnode,outer sep=.3cm] (h) at (-135:3) {
      \tikz[ingrphdiag]{
        \n[n1]{x}{0,0};
        \n[n2]{y}{.9,0};
      }};
    \node[grphnode,outer sep=.3cm] (h') at (-45:3) {
      \tikz[ingrphdiag,outer sep=0]{
        \e{0,0}{1.1,0};
        \begin{scope}[shift={(0,0)}]
          \n[n1]{x}{0,0};
          \site{rx}{x.east};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(1.1,0)}]
          \n[n2]{y}{0,0};
          \site{ly}{y.west};
          \node at (206:.42) {\scriptsize $l$};
        \end{scope}
      }};
    \path (g) edge[rule] node[above left] {$\psi$} (h);
    \path (g) edge[rule] node[above right] {$\phi$} (h');
    \path (h) edge[rule] node[below] {$\theta$} (h');
  \end{tikzpicture}
\end{center}

% workaround to push the next lonely sentence to the next page
% \bigskip

Rule application preserves epis
and in fact also prefixes of epis:
\begin{lemma}
  \label{lem:epi-prefix}
  Let $r = \tuple{r_L,r_R}$ be a rule
  and $\psi: r_L \to g$ be an embedding
  with $r_L,r_R,g$ contact maps in $\rSGe_C$.
  The embedding $\comatch{\psi}: r_R \to \comatch{g}$
  that results from applying $r$ to $\psi$
  is a prefix of an epi iff $\psi$ is.
\end{lemma}
\begin{proof}
  % Here we just prove that rule application preserves epis.
  % For prefixes of epis we have to make sure that
  % the mediating arrow (ie the witness of \phi \geq \psi)
  % is preserved as well.
  % This works because the new connected components in g
  % (added in the codomain of the prefix of epi)
  % are then connected to those in r_L through sites
  % that are not involved in the action of the rule,
  % since an edge addition requires the sites to be free
  % and an edge deletion requires them to be bound
  % but in no case they can be used to bind
  % the new connected components.
  % Embeddings preserve edges and free sites
  % so the sites involved in the action of the rule
  % have to be mentioned in the codomain of the prefix of epi.
  % Because rule applications will leave everything else intact
  % the mediating arrow is preserved.
  This amounts to proving that
  some embedding $\comatch{\phi} \geq \comatch{\psi}$
  is an epi if there is an epi $\phi \geq \psi$;
  the converse is true by symmetry of rules.
  For this it is enough to consider the case
  where the rule adds or deletes exactly one edge
  since rules that modify more than one edge at a time
  can be decomposed as sequences of deletions and insertions of edges;
  given that each deletion and insertion preserves the property,
  the sequence will preserve it as well.

  The case of adding an edge is easy as the image of $\comatch{\phi}$
  has fewer connected components to intersect than $\phi$.
  The case where $r$ deletes an edge
  can introduce new connected components,
  however in this case both ends $u,v$
  of the deleted edge must be in $r_L$,
  so whether the deletion disconnects or not the codomain of $\psi$,
  the components of $\comatch{\phi}(u)$ and $\comatch{\phi}(v)$
  will have a pre-image, namely $u$ and $v$.
\end{proof}

It follows that the category of extensions
of $r_L$ and $r_R$ are isomorphic.
Hence, any extension $\phi$ to a rule $r$ can be mapped to
an extension of its inverse rule $\inv{r}$.

A family of epis $\phi_i: g \to g_i$ \emph{uniquely decomposes} $g$,
or is a \emph{refinement} of $g$, if,
for all mixtures $m$ and embeddings $\psi: g \to m$,
there exists a unique $i$ and $\psi'$ such that $\psi = \psi' \phi_i$.
%; uniqueness of $i$ prevents the $\phi_i$s from overlapping.
%; since $\phi_i$ is an epi, there can be at most one such $\psi$.
This is the basic requirement
for a reasonable notion of rule refinement:
it guarantees that the left-hand side $g$ of a given rule
splits into a non-overlapping and exhaustive collection
of more specific cases $g_i$.

% For the partitioning of rules
% we need a guiding principle.

A method to easily construct such decompositions
was proposed by \citet{refinement}
which works by detailing
which agents and sites should be added to $g$.
This ``extension plan'' is called growth policy.
A \emph{growth policy} $\gp$ for contact map $g$ over $C$
is a family of functions $\gp_\phi$,
indexed by all extensions $\phi: g \to h$,
where $\gp_\phi$ maps $u \in \agents_{\anon{h}}$ to
a subset $\gp_\phi(u)$ of $\sitemap_C^{-1}(h_\agents(u))$,
\ie each agent in $\anon{h}$ is allocated
a subset of the sites belonging to the agent type $h_\agents(u)$
it is mapped to in the contact graph.
%
An agent in $\anon{h}$ may cover some, or all,
of these sites or even completely extraneous sites:
if the former, \ie if for all $u$ in $\agents_{\anon{h}}$,
$h_\sites(\sitemap_{\anon{h}}^{-1}(u)) \subset \gp_\phi(u)$,
we say that $\phi$ is \emph{immature};
if for all $u$s the inclusion is an equality
and $\phi$ is an epi,
% $h_\sites(\sitemap_{\anon{h}}^{-1}(u)) = \gp_\phi(u)$,
we say that $\phi$ is \emph{mature};
otherwise $\phi$ is said to be \emph{overgrown}.
The functions $\gp_\phi$ must satisfy,
for all extensions $\phi$ and $\phi' \geq \phi$,
the \emph{faithfulness} property,
$\gp_\phi = \gp_{\phi'} \, \psi_\agents$
with $\psi$ such that $\psi \, \phi = \phi'$;
so a site requested by $\phi$
must be requested by any further extension.
Additionally, this property forces $\gp$ to eagerly ask
for all sites that will be eventually requested
at any given agent in the codomain of $\phi$.
If $\phi$ is not overgrown
then no $\phi' \leq \phi$ is overgrown either.
% Also, note that the union of two growth policies
% is itself a growth policy.

Given a contact map $g$ over $C$ and a growth policy $\gp$ for $g$,
we define $\gp(g)$ by choosing one representative
per $\cong_g$-isomorphism class of the set of all extensions of $g$
which are mature according to $\gp$.

The following theorem guarantees that
factorisations through $\gp(g)$ are unique when they exist,
but \emph{not} that they necessarily do exist.
In section \sct{energy-gp},
we will construct a specific growth policy % of interest
for which this property of exhaustivity of the decomposition
can be proved by hand.
As such, it fulfils our desired criteria of providing
an exhaustive collection of mutually exclusive sub-cases.

\begin{theorem}
  \label{thm:unique-decomposition}
  % If $\gp$ is a growth policy for $g$,
  % $\gp(g)$ uniquely decomposes $g$.
  Let $g$ and $m$ be contact maps over $C$
  and $\gp$ a growth policy for $g$.
  If an embedding $\psi: g \to m$ can be decomposed
  in two ways as $\gamma_1 \phi_1$ and $\gamma_2 \phi_2$
  with $\phi_i: g \to h_i$ in $\gp(g)$ and $\gamma_i: h_i \to m$,
  then $\phi_1 = \phi_2$ and $\gamma_1 = \gamma_2$.
  \begin{equation}
    \label{eq:gp}
    \tikz[baseline=-4.3]{
      \matrix (m) [matrix of math nodes,row sep=25pt,column sep=25pt]{
        g & & & h_1 \\
        & p & & \\
        & & m & \\
        h_2 & & & m \\};
      % outer square
      \draw[hom] (m-1-1) -- node[above] {$\phi_1$} (m-1-4);
      \draw[hom] (m-1-1) -- node[left] {$\phi_2$} (m-4-1);
      \draw[hom] (m-4-1) -- node[below] {$\gamma_2$} (m-4-4);
      \draw[hom] (m-1-4) -- node[right] {$\gamma_1$} (m-4-4);
      % inner square
      \draw[hom] (m-2-2) -- node[onarrow] {$\pi_1$} (m-4-1);
      \draw[hom] (m-2-2) -- node[onarrow] {$\pi_2$} (m-1-4);
      \draw[hom] (m-4-1) -- node[onarrow] {$\theta_1$} (m-3-3);
      \draw[hom] (m-1-4) -- node[onarrow] {$\theta_2$} (m-3-3);
      % mediating arrows
      \draw[hom] (m-1-1) -- node[onarrow] {$\phi$} (m-2-2);
      \draw[hom,dashed] (m-3-3) -- (m-4-4);
    }
  \end{equation}
\end{theorem}
\begin{proof}
  Suppose that $\gamma_1 \phi_1 = \gamma_2 \phi_2$,
  where $\phi_1$ and $\phi_2$ are mature extensions of $g$
  according to $\gp$ and $\phi_1 \neq \phi_2$.
  As shown in \diagram{gp},
  we have an inner square formed by the pullback $\pi_1,\pi_2$,
  and the minimal glueing $\theta_1,\theta_2$ of $h_1,h_2$
  that factors $\gamma_1,\gamma_2$.
  Every connected component of $m$
  has a pre-image in $h_1$ or $h_2$,
  and thus also in $g$,
  since $\phi_1$ and $\phi_2$ are epis
  as mature extensions.
  Because every connected component of $m$
  has an image in $h_1$ and $h_2$,
  then evey connected component of $m$
  has a pre-image in both $h_1$ and $h_2$.
  Hence $\theta_1$ and $\theta_2$ are epis.
  % Also $\theta_1$ and $\theta_2$ are epis,
  % as every connected component of $m$
  % has a pre-image in $h_1$ or $h_2$
  % and so also in $g$, since the $\phi_i$s are epis,
  % and so also in the other of $h_2$ and $h_1$.

  The nodes in the images of $\theta_1$ and $\theta_2$
  might be the same or differ.
  When they differ, some site $z$ sitting on a node
  in the intersection of the images of $\theta_1,\theta_2$
  is connected to a node outside the image,
  since $\theta_1,\theta_2$ are epis.
  However, $z$ cannot be in the intersection of the images
  unless the site it is connected to is also part of the intersection
  (\lem{mg}).
  Therefore the nodes in the images must be the same.
  In this case there has to be a site $z$
  that is not in the image of one of them
  or $\theta_1,\theta_2$ are both isos.
  So there must be a pair $u,z$,
  consisting of a node $u$ in $m$
  with pre-images $u_1,u_2$ in $h_1,h_2$
  and a site $z$ of $u$,
  such that $z$ has no pre-image
  in exactly one of $\theta_1,\theta_2$.
  Say it is $\theta_2$.
  Since $\phi_1$ is not overgrown,
  $z \in \gp_{\phi_1}(u_1)$ and, by faithfulness,
  $z \in \gp_\phi(\tuple{u_1,u_2})$,
  where $\tuple{u_1,u_2}$ is
  the pullback pre-image of $u_1$ and $u_2$.
  So again, by faithfulness, $z \in \gp_{\phi_2}(u_2)$
  which contradicts our original assumption.
  Hence, $\theta_1$ and $\theta_2$ are isos.
  It follows that $\phi_1 = \phi_2$ as there is only
  one representative per $\cong_g$-isomorphism class in $\gp(g)$.
  Finally, $\gamma_1 = \gamma_2$ because $\phi_1$ is an epi.
\end{proof}
% NB: the argument uses the faithful condition
% in both directions to push around the $z$ site.

Given a rule $r$ and an extension $\phi: r_L \to g$, % of $r_L$,
we write $r_\phi$ for the refined rule associated to $\phi$,
% $r_\phi$ denotes the refined rule associated to $\phi$,
that is, $r_\phi$ is the pair $(g,g^{(r,\phi)})$.
%
Given $\gp$ a growth policy for $r_L$,
we write $\gp(r)$ for the family of rules
obtained by refining $r$ according to $\gp$,
that is, $\gp(r)$ is the family of rules $r_\phi$
for $\phi$ ranging in $\gp(r_L)$.

An example of growth policy is the \emph{ground} policy
which assigns all possible sites to all agents.
In this case, $\gp(g)$ is simply the set, possibly infinite,
of all epis of $g$ into mixtures, considered up to $\cong_g$.
The ground refinement $\gp(r)$ % of $r$
contains all refinements of $r$ along those epis.
The refined rules therefore manipulate mixtures directly.
It is easy to see that the ground refinement of $r^+_{12}$
in our example is infinite,
since $r^+_{12}$ % each of the three rules
can trigger the extension of a chain of any length.
A similar argument is true for $r^-_{12}$.
Note that ground refinements of a rule $r$
are trivially $\shapes$-balanced but, in general,
the set of refined rules is impractically large or infinite as above.
Instead, the growth policy that we introduce
in the next section % \sct{energy-gp}
will always be finite.


\section{Thermodynamic growth policy} % Energy-based refinement}
\label{sec:energy-gp}

An extension $\phi$ of a rule $r$ is $\shapes$-balanced
if it generates a refined rule $r_\phi$ that is $\shapes$-balanced.
To find such extensions % $\shapes$-balanced extensions of a rule $r$,
it seems natural to use minimal glueings:
take as extensions the right leg $\theta^i_2$
of each relevant minimal glueing
$\theta^i_1: p \to s_i \gets r_L :\theta^i_2$
of $p \in \shapes$ and $r_L$ (or $r_R$).
For instance, the only relevant minimal glueing of
the right-hand side of $r^+_{12}$ and the triangle is
\begin{center}
  \begin{tikzpicture}[thick]
    \begin{scope}
      %%% Rhs: 1-2 %%%
      \node[grphnode,anchor=south] (rr) at (150:2.5) {
        \tikz[ingrphdiag]{
          \e{0,0}{1.1,0};
          \begin{scope}
            \n[n1]{n1}{0,0};
            \site{r1}{n1.east};
            \node at (26:.42) {\scriptsize $r$};
          \end{scope}
          \begin{scope}[shift={(1.1,0)}]
            \n[n2]{n2}{0,0};
            \site{l2}{n2.west};
            \node at (206:.42) {\scriptsize $l$};
          \end{scope}
        }};

      %%% Triangle %%%
      \node[grphnode,anchor=south] (p) at (30:2.5) {
        \tikz[ingrphdiag]{
          \e{0,0}{0:1.1};
          \e{0,0}{-60:1.1};
          \e{0:1.1}{-60:1.1};
          \begin{scope}[shift={(0,0)}]
            \n[n1]{x}{0,0};
            \site{r1}{0:7pt};
            \site{l1}{-60:7pt};
            \node at (-86:12pt) {\scriptsize $l$};
            \node at (26:12pt) {\scriptsize $r$};
          \end{scope}
          \begin{scope}[shift={(0:1.1)}]
            \n[n2]{y}{0,0};
            \site{r2}{180:7pt};
            \site{l2}{-120:7pt};
            \node at (154:12pt) {\scriptsize $l$};
            \node at (-94:12pt) {\scriptsize $r$};
          \end{scope}
          \begin{scope}[shift={(-60:1.1)}]
            \n[n3]{z}{0,0};
            \site{r3}{120:7pt};
            \site{l3}{60:7pt};
            \node at (146:12pt) {\scriptsize $r$};
            \node at (34:12pt) {\scriptsize $l$};
          \end{scope}
        }};

      %%% Triangle %%%
      \node[grphnode,anchor=north] (mg) at (0,0) {
        \tikz[ingrphdiag]{
          \e{0,0}{0:1.1};
          \e{0,0}{-60:1.1};
          \e{0:1.1}{-60:1.1};
          \begin{scope}[shift={(0,0)}]
            \n[n1]{x}{0,0};
            \site{r1}{0:7pt};
            \site{l1}{-60:7pt};
            \node at (-86:12pt) {\scriptsize $l$};
            \node at (26:12pt) {\scriptsize $r$};
          \end{scope}
          \begin{scope}[shift={(0:1.1)}]
            \n[n2]{y}{0,0};
            \site{r2}{180:7pt};
            \site{l2}{-120:7pt};
            \node at (154:12pt) {\scriptsize $l$};
            \node at (-94:12pt) {\scriptsize $r$};
          \end{scope}
          \begin{scope}[shift={(-60:1.1)}]
            \n[n3]{z}{0,0};
            \site{r3}{120:7pt};
            \site{l3}{60:7pt};
            \node at (146:12pt) {\scriptsize $r$};
            \node at (34:12pt) {\scriptsize $l$};
          \end{scope}
        }};

      \draw[-bigto,opacity=.7]
      ($(rr.south)!.1!(mg.north)$)
      -- node[pos=.4,below left,opacity=1] {$\comatch{\phi}$}
      ($(rr.south)!.9!(mg.north)$);
      % \arrsn[opacity=.7]{rr}{mg};
      \arrsn[opacity=.7]{p}{mg};
    \end{scope}
  \end{tikzpicture}
\end{center}
If we use $\phi$ ---
the embedding coresponding to $\comatch{\phi}$
on the left-hand side ---
as an extension of $r^+_{12}$
we obtain rule~\ref{eq:refined1}.
Now, having found the only extension of $r^+_{12}$
that produces a triangle,
we are left with the problem of finding
the extensions that cover the cases when $r^+_{12}$
can be applied without producing a triangle.
Intuitively, one must handle the cases
when the $l$ site of the orange node
or the $r$ site of the blue node are free
(as in rule~\ref{eq:refined2}).

% We say that a balanced extension $\phi$ is \emph{prime}
% iff it is minimally so,
% \ie any prefix of $\phi$ that is $\shapes$-balanced
% is isomorphic to $\phi$ as an extension of $r_L$.
% Prime extensions are epis since erasing an `untouched'
% connected component in the codomain preserves balance.

% If $\phi$ is a $\shapes$-balanced extension of $r$,
% the refined rule $r_\phi$
% has a \emph{balance vector} in $\ZZ^\shapes$,
% written $\Delta\phi$, where, for each $p \in \shapes$,
% $\Delta\phi(p)$ is the number of copies of $p$
% produced by \emph{any} $r_\phi$-event,
% which is also the difference between the number of embeddings
% of $p$ in the right-hand and the left-hand side of $r_\phi$.


\section{Linear kinetic model}
\label{sec:kinetic-model}

% is the linear kinetic model related to "Parameters for
% the description of transition states", John Leffler, Science, 1953
% https://sci-hub.ac/10.2307/1680906
% it says "we approximate the transition state as a hybrid between
% the reagent and product states"
% "whenever the plot of the logarithm of the rate constant
%  against the equilibrium constant is a straight line,
%  the approximation is justified"
% "it should then be possible to predict
%  the free energy of the transition state by a linear combination of
%  the predictions made for the reagents and for the products"
%
% if we then relate the free energy of the transition state to
% the rate constants using Arrhenius?
% this has been done in transition state theory
% https://en.wikipedia.org/wiki/Eyring_equation
%
% do we get additional constraints on kinetic rates from cycles
% in the transition graph? when two cycles share an edge?


\section{Example: Flagellum's motor}
\label{sec:alloring}




%%% Local Variables:
%%% mode: latex
%%% TeX-master: "thesis"
%%% End:
