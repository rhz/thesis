In this chapter we show how to construct a set of reversible rules
and their forward and backward rate constants from an energy function.
In the spirit of rule-based modelling languages like Kappa
where rules and observables are defined in terms of patterns,\footnote{
  Recall that a pattern is a contact map used to find subgraphs in states.}
we use a set of \emph{energy patterns} $\shapes$
for our energy function.
We assign an \emph{energy cost} $\cost(g)$ to each of them
and build the energy function as a linear combination
of their number of ocurrences. % of each energy pattern.
\[ E(m) = \sum_{g \in \shapes} \cost(g) \abs{\matches{g}{m}} \]
This is reminiscent of group contribution methods
used to estimate the standard Gibbs free energy of formation
of biomolecules \citep{group-contrib}.

As mentioned at the end of \sct{kappa},
we will derive the set of rules with detailed balance
from a set of generator rules $\generators$ (without rates).
We suppose that $\generators$ is closed under
rule inversion, \ie $\generators = \inv{\generators}$.
Given a contact graph $C$,
a simple option would be to include
every possible minimal rule in this set,
that is, include a creation and a destruction rule
for each edge in the contact graph.
Each of these rules is minimal in the sense that
it only asks for the presence of
the two participating agents and sites.
The example rule in \sct{kappa}
where agents of type $1$ and $2$ bind
% regardless of the binding state of any other site,
regardless of the context
in which these two agents happen to be,
which we denote by $r^+_{12}$,
is one such minimal rule
that can be derived from contact graph $T$.
This option is \emph{maximally permissive}
% as every possible transformation
% allowed by the contact graph
% is allowed by $\generators$.\footnote{
with respect to the contact graph.\footnote{
  Intuitively, this is analogous to the case of classical mechanics
  % where the topology of the space gives us the possible transformations
  where, a priori, movement is not constrained along in coordinate.}
Even if all transformations are possible,
many of them may be unlikely due to having a high energy.
Still one might prefer to forbid certain transformations
in some scenarios.
This is indeed the case in the example
that will be presented in \sct{alloring}.

In our previous example (\sct{kappa}),
we might want to favour the formation of
triangles over chains and other cycles.
For this we give a negative energy cost to $t$,
\ie $\cost(t) < 0$.
If $t$ is the only energy pattern,
then the energy of a state $m$ is
$E(m) = \cost(t) \abs{\matches{t}{m}}$.
In this model one might, for instance,
wonder how low the energy cost of $t$ must be
to have at least $90\%$ of all agents in a triangle
at equilibrium at least $90\%$ of the time.

We would like to find rules that have detailed balance
with respect to this energy function.
Consider the rule $r^+_{12}$ and its inverse $r^-_{12}$,
the unbinding of agents $1$ and $2$.
% Given the maximally permissive set of generator rules
% $\generators=\set{r^+_{12},r^-_{12},r^+_{23},r^-_{23},r^+_{31},r^-_{31}}$,
% we first ask ourselves if these reversible rules
We first ask ourselves if this pair of rules
could have detailed balance
for some assignment of kinetic rates.
% to the forward and backward rule.
Suppose we assign kinetic rates $k^+$ and $k^-$
to $r^+_{12}$ and $r^-_{12}$.
Recall from \sct{bg} that $e^{E(n)-E(m)} = q_{nm}/q_{mn}$
for systems with detailed balance.
From \eqn{kappa-ctmc}
\[ q_{mn} = \sum_{\substack{r \in \generators\\r = \tuple{r_L,r_R}}}
   k(r) \; \abs{\setof{\psi \in \matches{r_L}{m}}{m^{(r,\psi)} = n}}
\]
It is clear that at most one of the two rules
can bring us from state $m$ to $n$, say it is $r^+_{12}$.
By rule reversibility (\lem{reversibility})
$r^-_{12}$ brings us from $n$ back to $m$
and the number of matches of $r^-_{12}$ in $n$
is equal to the number of matches of $r^+_{12}$ in $m$.
Hence, $e^{E(n)-E(m)} = k^+/k^-$.
In words, the change in energy produced by the rule application
fixes the ratio between the kinetic rates.
As a consequence,
each rule application should produce the same energy change
for there to be an assignment of kinetic rates with detailed balance.
Whenever a rule produces the same energy change
regardless of where it is applied
we say that the rule has an \emph{unambiguous energy balance}
or is $\shapes$-balanced.
The following two rule applications show that
$r^+_{12}$ is not $\shapes$-balanced.
\begin{center}
  \resizebox{.9\linewidth}{!}{%
  \begin{tikzpicture}[thick]
    % first row
    \node[grphnode,anchor=east] (lhs1) at (0,0) {
      \tikz[ingrphdiag]{
        \begin{scope}[shift={(0,0)}]
          \n[n1]{x}{0,0};
          \e{x}{.5,0};
          \site{rx}{x.east};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(1.2,0)}]
          \n[n2]{y}{0,0};
          \e{y}{-.5,0};
          \site{ly}{y.west};
          \node at (206:.42) {\scriptsize $l$};
        \end{scope}
      }};
    \path (lhs1.east) +(.3,0) edge[rule,dotted] +(1,0)
      +(1.3,0) coordinate (r1);
    \node[grphnode,anchor=west] (rhs1) at (r1) {
      \tikz[ingrphdiag]{
        \e{0,0}{1.1,0};
        \begin{scope}
          \n[n1]{x}{0,0};
          \site{rx}{x.east};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(1.1,0)}]
          \n[n2]{y}{0,0};
          \site{ly}{y.west};
          \node at (206:.42) {\scriptsize $l$};
        \end{scope}
      }};
    % second column
    \node[grphnode,anchor=east] (lhs2) at (9,0) {
      \tikz[ingrphdiag]{
        \begin{scope}[shift={(0,0)}]
          \n[n1]{x}{0,0};
          \e{x}{.5,0};
          \site{rx}{x.east};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(1.2,0)}]
          \n[n2]{y}{0,0};
          \e{y}{-.5,0};
          \site{ly}{y.west};
          \node at (206:.42) {\scriptsize $l$};
        \end{scope}
      }};
    \path (lhs2.east) +(.3,0) edge[rule,dotted] +(1,0)
      +(1.3,0) coordinate (r2);
    \node[grphnode,anchor=west] (rhs2) at (r2) {
      \tikz[ingrphdiag]{
        \e{0,0}{1.1,0};
        \begin{scope}
          \n[n1]{x}{0,0};
          \site{rx}{x.east};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(1.1,0)}]
          \n[n2]{y}{0,0};
          \site{ly}{y.west};
          \node at (206:.42) {\scriptsize $l$};
        \end{scope}
      }};
    % second row
    \path (lhs1.south) +(0,-.2) edge[rule] +(0,-.6);
    \node[grphnode,anchor=east] (lhs3) at (0,-2) {
      \tikz[ingrphdiag]{
        \begin{scope}[shift={(0,0)}]
          \n[n1]{x}{0,0};
          \e{x}{.5,0};
          \e{x}{-.5,0};
          \site{lx}{x.west};
          \site{rx}{x.east};
          \node at (206:.42) {\scriptsize $l$};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \e{1.2,0}{2.3,0};
        \begin{scope}[shift={(1.2,0)}]
          \n[n2]{y}{0,0};
          \e{y}{-.5,0};
          \site{ly}{y.west};
          \site{ry}{y.east};
          \node at (206:.42) {\scriptsize $l$};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(2.3,0)}]
          \n[n3]{z}{0,0};
          \e{z}{.5,0};
          \site{lz}{z.west};
          \site{rz}{z.east};
          \node at (206:.42) {\scriptsize $l$};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
      }};
    \path (lhs3.east) +(.3,0) edge[rule,dotted] +(1,0)
      +(1.3,0) coordinate (r3);
    \path (rhs1.south) +(0,-.2) edge[rule] +(0,-.6);
    \node[grphnode,anchor=west] (rhs3) at (r3) {
      \tikz[ingrphdiag]{
        \e{0,0}{2.2,0};
        \begin{scope}[shift={(0,0)}]
          \n[n1]{x}{0,0};
          \e{x}{-.5,0};
          \site{lx}{x.west};
          \site{rx}{x.east};
          \node at (206:.42) {\scriptsize $l$};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(1.1,0)}]
          \n[n2]{y}{0,0};
          \site{ly}{y.west};
          \site{ry}{y.east};
          \node at (206:.42) {\scriptsize $l$};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(2.2,0)}]
          \n[n3]{z}{0,0};
          \e{z}{.5,0};
          \site{lz}{z.west};
          \site{rz}{z.east};
          \node at (206:.42) {\scriptsize $l$};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
      }};
    % second row, second column
    \path (lhs2.south) +(0,-.2) edge[rule] +(0,-.6);
    \node[grphnode,anchor=east] (lhs4) at (9,-2.4) {
      \tikz[ingrphdiag]{
        \e{0,0}{-56.944:1.1};
        \e{0:1.2}{-56.944:1.1};
        \begin{scope}[shift={(0,0)}]
          \n[n1]{x}{0,0};
          \e{x}{.5,0};
          \site{r1}{0:7pt};
          \site{l1}{-60:7pt};
          \node at (-86:12pt) {\scriptsize $l$};
          \node at (26:12pt) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(0:1.2)}]
          \n[n2]{y}{0,0};
          \e{y}{-.5,0};
          \site{r2}{180:7pt};
          \site{l2}{-120:7pt};
          \node at (154:12pt) {\scriptsize $l$};
          \node at (-94:12pt) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(-56.944:1.1)}]
          \n[n3]{z}{0,0};
          % angle is 66.111 deg
          \site{r3}{123.0555:7pt};
          \site{l3}{56.9445:7pt};
          \node at (146:12pt) {\scriptsize $r$};
          \node at (34:12pt) {\scriptsize $l$};
        \end{scope}
      }};
    \path (lhs4.east) +(.3,0) edge[rule,dotted] +(1,0)
      +(1.3,0) coordinate (r4);
    \path (rhs2.south) +(0,-.2) edge[rule] +(0,-.6);
    \node[grphnode,anchor=west] (rhs4) at (r4) {
      \tikz[ingrphdiag]{
        \e{0,0}{0:1.1};
        \e{0,0}{-60:1.1};
        \e{0:1.1}{-60:1.1};
        \begin{scope}[shift={(0,0)}]
          \n[n1]{x}{0,0};
          \site{r1}{0:7pt};
          \site{l1}{-60:7pt};
          \node at (-86:12pt) {\scriptsize $l$};
          \node at (26:12pt) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(0:1.1)}]
          \n[n2]{y}{0,0};
          \site{r2}{180:7pt};
          \site{l2}{-120:7pt};
          \node at (154:12pt) {\scriptsize $l$};
          \node at (-94:12pt) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(-60:1.1)}]
          \n[n3]{z}{0,0};
          \site{r3}{120:7pt};
          \site{l3}{60:7pt};
          \node at (146:12pt) {\scriptsize $r$};
          \node at (34:12pt) {\scriptsize $l$};
        \end{scope}
      }};
  \end{tikzpicture}}
\end{center}

We see that, while the application on the left
does not produce any change in energy ($\Delta E = 0$),
the one on the right creates a triangle
and thus $\Delta E = \cost(t)$.\footnote{
  We can't tolerate energetical ambiguity! Heresy!}
We must then split $r^+_{12}$ into subrules that check
the surroundings of the rule application
to make sure that, for instance,
every application of such a subrule
creates one triangle or none at all.
It is important that the partition of the rule
has certain properties.
In particular, one would like that every match of the rule
can be mapped to exactly one match of one of the subrules.
Prior work by \citet{refinement} has shown how
one can obtain a partition of rules with this property
and will be presented, in a slightly modified version,
in the next section. % \sct{refinements}.

% For the partitioning of rules
% we need a guiding principle.


\section{Refinements}
\label{sec:refinements}

A rule is refined into another rule by adding context.
For example, we can add a common neighbour
to the agents in $r^+_{12}$ to obtain a refinement.
\begin{center}
  \begin{tikzpicture}
    \node[grphnode,anchor=east] (lhs) at (0,0) {
      \tikz[ingrphdiag]{
        \e{0,0}{-56.944:1.1};
        \e{0:1.2}{-56.944:1.1};
        \begin{scope}[shift={(0,0)}]
          \n[n1]{x}{0,0};
          \e{x}{.5,0};
          \site{r1}{0:7pt};
          \site{l1}{-60:7pt};
          \node at (-86:12pt) {\scriptsize $l$};
          \node at (26:12pt) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(0:1.2)}]
          \n[n2]{y}{0,0};
          \e{y}{-.5,0};
          \site{r2}{180:7pt};
          \site{l2}{-120:7pt};
          \node at (154:12pt) {\scriptsize $l$};
          \node at (-94:12pt) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(-56.944:1.1)}]
          \n[n3]{z}{0,0};
          % angle is 66.111 deg
          \site{r3}{123.0555:7pt};
          \site{l3}{56.9445:7pt};
          \node at (146:12pt) {\scriptsize $r$};
          \node at (34:12pt) {\scriptsize $l$};
        \end{scope}
      }};
    \path (lhs.east) +(.3,0) edge[rule] +(1,0)
      +(1.3,0) coordinate (r);
    \node[grphnode,anchor=west] (rhs) at (r) {
      \tikz[ingrphdiag]{
        \e{0,0}{0:1.1};
        \e{0,0}{-60:1.1};
        \e{0:1.1}{-60:1.1};
        \begin{scope}[shift={(0,0)}]
          \n[n1]{x}{0,0};
          \site{r1}{0:7pt};
          \site{l1}{-60:7pt};
          \node at (-86:12pt) {\scriptsize $l$};
          \node at (26:12pt) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(0:1.1)}]
          \n[n2]{y}{0,0};
          \site{r2}{180:7pt};
          \site{l2}{-120:7pt};
          \node at (154:12pt) {\scriptsize $l$};
          \node at (-94:12pt) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(-60:1.1)}]
          \n[n3]{z}{0,0};
          \site{r3}{120:7pt};
          \site{l3}{60:7pt};
          \node at (146:12pt) {\scriptsize $r$};
          \node at (34:12pt) {\scriptsize $l$};
        \end{scope}
      }};
  \end{tikzpicture}
\end{center}
This refinement happens to be $\shapes$-balanced.
Another refinement of $r^+_{12}$ could be
\begin{center}
  \begin{tikzpicture}
    \node[grphnode,anchor=east] (lhs) at (0,0) {
      \tikz[ingrphdiag]{
        \begin{scope}[shift={(0,0)}]
          \n[n1]{x}{0,0};
          \e{x}{.5,0};
          \site{rx}{x.east};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(1.2,0)}]
          \n[n2]{y}{0,0};
          \e{y}{-.5,0};
          \e{y}{.5,0};
          \site{ly}{y.west};
          \site{ry}{y.east};
          \node at (206:.42) {\scriptsize $l$};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
      }};
    \path (lhs.east) +(.3,0) edge[rule] +(1,0)
      +(1.3,0) coordinate (r);
    \node[grphnode,anchor=west] (rhs) at (r) {
      \tikz[ingrphdiag]{
        \e{0,0}{1.1,0};
        \begin{scope}
          \n[n1]{x}{0,0};
          \site{rx}{x.east};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(1.1,0)}]
          \n[n2]{y}{0,0};
          \e{y}{-.5,0};
          \e{y}{.5,0};
          \site{ly}{y.west};
          \site{ry}{y.east};
          \node at (206:.42) {\scriptsize $l$};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
      }};
  \end{tikzpicture}
\end{center}
Here we have added a free site to the blue node.
This second refinement is also $\shapes$-balanced
because the free $r$ site on the blue node guarantees that
the rule will never create a triangle.
The following refinement, however, is not $\shapes$-balanced.
\begin{center}
  \begin{tikzpicture}
    \node[grphnode,anchor=east] (lhs) at (0,0) {
      \tikz[ingrphdiag]{
        \begin{scope}[shift={(0,0)}]
          \n[n1]{x}{0,0};
          \e{x}{.5,0};
          \site{rx}{x.east};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \e{1.2,0}{2.3,0};
        \begin{scope}[shift={(1.2,0)}]
          \n[n2]{y}{0,0};
          \e{y}{-.5,0};
          \site{ly}{y.west};
          \site{ry}{y.east};
          \node at (206:.42) {\scriptsize $l$};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(2.3,0)}]
          \n[n3]{z}{0,0};
          \site{lz}{z.west};
          \node at (206:.42) {\scriptsize $l$};
        \end{scope}
      }};
    \path (lhs.east) +(.3,0) edge[rule] +(1,0)
      +(1.3,0) coordinate (r);
    \node[grphnode,anchor=west] (rhs) at (r) {
      \tikz[ingrphdiag]{
        \e{0,0}{2.2,0};
        \begin{scope}[shift={(0,0)}]
          \n[n1]{x}{0,0};
          \site{rx}{x.east};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(1.1,0)}]
          \n[n2]{y}{0,0};
          \site{ly}{y.west};
          \site{ry}{y.east};
          \node at (206:.42) {\scriptsize $l$};
          \node at (26:.42) {\scriptsize $r$};
        \end{scope}
        \begin{scope}[shift={(2.2,0)}]
          \n[n3]{z}{0,0};
          \site{lz}{z.west};
          \node at (206:.42) {\scriptsize $l$};
        \end{scope}
      }};
  \end{tikzpicture}
\end{center}

We add context to a rule $r = \tuple{r_L,r_R}$
by applying the rule to an embedding $\psi: r_L \to g$.
This operation is well-defined
even if the codomain of the embedding is not a mixture.
% The result of the rewrite $g^{(r,\psi)}$
The pair of contact maps $(g,g^{(r,\psi)})$
% with $g^{(r,\psi)}$ the result of the rewrite
is itself a valid rule
since they only differ in their edge structure.
In this way, an extension of a rule
is determined uniquely by an embedding.

% Epis of $\rSGe_C$ are characterised as follows:
% suppose $s: G \to C$ and $t: H \to C$ are contact maps then
% $\phi: s \to t$ in $\rSGe_C$ is an epi iff
% every connected component of $H$ contains at least
% one agent in the image of $\phi_\agents$.
Epis\footnote{
  Epi, mono and iso are short for
  epimorphism, monomorphism and isomorphism.}
% of $\rSGe_C$ are used to add context to rules
% of $\rSGe_C$ are useful when adding context to rules
% of $\rSGe_C$ are a good candidate to use as embeddings
% when adding context to rules.
% because every connected component of their codomain
% has at least one agent with a pre-image.
of $\rSGe_C$ are good candidates for extensions.
They are characterised as follows:
$\psi: s \to t$ is an epi iff
every connected component of $s$ contains
at least one agent in the image of $\psi_\agents$.
This ensures that no new connected component is added to the rule
while extending it.
However, for technical reasons
that will become apparent in \thm{unique-decomposition},
we use prefixes of epis
instead of epis to extend rules ---
an embedding $\psi: s \to t$ is said to be
a \emph{prefix} of $\phi: s \to t'$
if there is some embedding $\theta: t \to t'$
that makes the composition of $\psi$ and $\theta$ equal to $\phi$
(\ie $\theta \, \psi = \phi$) % psychology + tetas = philosophy
and write $\psi \leq \phi$ for this.
We refer to a prefix of an epi
\begin{wrapfigure}[4]{r}{0.3\textwidth}
  \vspace{-2em}
  \begin{center}
    \begin{tikzpicture}
      \matrix (m) [matrix of math nodes,row sep=25pt,column sep=25pt] {
        & s & \\
        t_1 & & t_2 \\};
      \draw[hom] (m-1-2) -- node[above left] {$\psi$} (m-2-1);
      \draw[hom] (m-1-2) -- node[above right] {$\phi$} (m-2-3);
      \draw[hom] (m-2-1) -- node[below] {$\theta$} (m-2-3);
    \end{tikzpicture}
  \end{center}
\end{wrapfigure}
$\phi: s \to t$ as an \emph{extension} of $s$.
In the category of extensions of $s$,
a morphism between objects $\psi: s \to t_1$ and $\phi: s \to t_2$
is an embedding $\theta: t_1 \to t_2$
such that the triangle on the right commutes.
If $\theta$ is an iso we write $\psi \cong_s \phi$.

Rule application preserves epis
and in fact also prefixes of epis:
\begin{lemma}
  \label{lem:epi-prefix}
  Let $r = \tuple{r_L,r_R}$ be a rule
  and $\psi: r_L \to g$ be an embedding
  with $r_L,r_R,g$ contact maps in $\rSGe_C$.
  The embedding $\comatch{\psi}: r_R \to \comatch{g}$
  that results from applying $r$ to $\psi$
  is a prefix of an epi iff $\psi$ is.
\end{lemma}
\begin{proof}
  This amounts to proving that
  some embedding $\comatch{\phi} \geq \comatch{\psi}$
  is an epi if there is an epi $\phi \geq \psi$;
  the converse is true by symmetry of rules.
  For this it is enough to consider the case
  where the rule adds or deletes exactly one edge
  since rules that modify more than one edge at a time
  can be decomposed as sequences of deletions and insertions of edges;
  given that each deletion and insertion preserves the property,
  the sequence will preserve it as well.

  The case of adding an edge is easy as the image of $\comatch{\phi}$
  has fewer connected components to intersect than $\phi$.
  The case where $r$ deletes an edge
  can introduce new connected components,
  however in this case both ends $u,v$
  of the deleted edge must be in $r_L$,
  so whether the deletion disconnects or not the codomain of $\psi$,
  the components of $\comatch{\phi}(u)$ and $\comatch{\phi}(v)$
  will have a pre-image, namely $u$ and $v$.
\end{proof}

It follows that the category of extensions
of $r_L$ and $r_R$ are isomorphic.

\begin{theorem}
  \label{thm:unique-decomposition}
\end{theorem}







\section{Minimal glueings}
\label{sec:mg}


\section{Energy-based refinement}
\label{sec:energy-gp}


\section{Linear kinetic model}
\label{sec:kinetic-model}

% is the linear kinetic model related to "Parameters for
% the description of transition states", John Leffler, Science, 1953
% https://sci-hub.ac/10.2307/1680906
% it says "we approximate the transition state as a hybrid between
% the reagent and product states"
% "whenever the plot of the logarithm of the rate constant
%  against the equilibrium constant is a straight line,
%  the approximation is justified"
% "it should then be possible to predict
%  the free energy of the transition state by a linear combination of
%  the predictions made for the reagents and for the products"
%
% if we then relate the free energy of the transition state to
% the rate constants using Arrhenius?
% this has been done in transition state theory
% https://en.wikipedia.org/wiki/Eyring_equation
%
% do we get additional constraints on kinetic rates from cycles
% in the transition graph? when two cycles share an edge?


\section{Flagellum's motor}
\label{sec:alloring}




%%% Local Variables:
%%% mode: latex
%%% TeX-master: "thesis"
%%% End:
